<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>HALUDAKE Mobile v7</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<style>
:root {
  --primary: #409eff; --danger: #f56c6c; --bg-app: #f4f7f9;
  --bg-card: #ffffff; --text: #2c3e50; --border: #dcdfe6;
}
[data-theme="dark"] {
  --bg-app: #1a1a1a; --bg-card: #2d2d2d; --text: #e0e0e0; --border: #444444;
}

body { margin: 0; font-family: sans-serif; height: 100dvh; display: flex; flex-direction: column; overflow: hidden; background: var(--bg-app); color: var(--text); }

/* ãƒ˜ãƒƒãƒ€ãƒ¼ãƒ»ãƒŠãƒ“ */
#header { height: 50px; background: var(--bg-card); display: flex; justify-content: space-between; align-items: center; padding: 0 15px; border-bottom: 1px solid var(--border); z-index: 1000; }
#main-view { flex: 1; overflow: hidden; display: flex; flex-direction: column; }
.tab-content { display: none; height: 100%; overflow-y: auto; background: var(--bg-app); -webkit-overflow-scrolling: touch; }
.tab-content.active { display: block; }

/* æœ¬æ–‡ã‚¨ãƒªã‚¢ */
#right { padding: 20px 15px 220px; line-height: 1.8; font-size: 17px; white-space: pre-wrap; word-break: break-all; min-height: 100%; color: var(--text); background: var(--bg-card); outline: none; }
.selected-range { background-color: rgba(64, 158, 255, 0.25); border-bottom: 2px solid var(--primary); }

/* ç½®æ›ãƒ‘ãƒãƒ« */
#replacePanel { display: none; background: var(--bg-card); padding: 10px; border-bottom: 2px solid var(--primary); flex-direction: column; gap: 8px; }
#replacePanel input { padding: 12px; border: 1px solid var(--border); border-radius: 8px; background: var(--bg-app); color: var(--text); font-size: 16px; }

/* ç®¡ç†ç”»é¢ */
.chapter { border: 1px solid var(--border); margin: 10px; border-radius: 8px; background: var(--bg-card); overflow: hidden; }
.chapter-title { padding: 12px 15px; background: rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; font-weight: bold; }
.chapter-anchors.collapsed { display: none; }
.anchor { display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; border-bottom: 1px solid var(--border); background: var(--bg-card); font-size: 14px; }
.anchor-txt { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; padding-right: 10px; }

/* æ“ä½œUI */
#nav { height: 70px; background: #333; display: flex; justify-content: space-around; align-items: center; z-index: 2000; padding-bottom: env(safe-area-inset-bottom); }
.nav-item { color: #ccc; font-size: 11px; text-align: center; border: none; background: none; flex: 1; }
.nav-item.active { color: var(--primary); font-weight: bold; }

/* æµ®å‹•ã‚¢ãƒ³ã‚«ãƒ¼ä½œæˆãƒœã‚¿ãƒ³ */
#float-btn { display: none; position: fixed; bottom: 85px; left: 15px; right: 15px; z-index: 4000; background: var(--primary); color: white; padding: 18px; border-radius: 12px; font-weight: bold; border: none; font-size: 18px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); }

/* å…±é€šãƒ‘ãƒ¼ãƒ„ */
.menu-btn { width: calc(100% - 20px); margin: 8px 10px; padding: 14px; border-radius: 10px; border: 1px solid var(--border); background: var(--bg-card); color: var(--text); font-weight: bold; font-size: 15px; }
.del-btn { color: var(--danger); font-size: 22px; padding: 0 10px; background: none; border: none; font-weight: bold; }

/* ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ */
#toast-container { position: fixed; bottom: 160px; left: 50%; transform: translateX(-50%); z-index: 9999; pointer-events: none; }
.toast { background: rgba(44, 62, 80, 0.9); color: white; padding: 12px 24px; border-radius: 50px; font-size: 14px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); margin-top: 8px; opacity: 0; transform: translateY(20px); transition: 0.3s; white-space: nowrap; }
.toast.show { opacity: 1; transform: translateY(0); }
.toast.error { background: var(--danger); }
</style>
</head>
<body>

<div id="header">
  <div id="themeToggle" style="font-size: 24px;">ğŸŒ™</div>
  <div style="font-weight: bold;">HALUDAKE Mobile v7</div>
  <div id="editControls">
    <button id="editBtn" onclick="toggleEdit(true)" style="border:none; background:none; font-size:24px;">âœ</button>
    <button id="finishBtn" onclick="toggleEdit(false)" style="display:none; border:none; background:none; font-size:24px; color:var(--primary);">âœ“</button>
  </div>
</div>

<div id="replacePanel">
  <input type="text" id="findText" placeholder="æ¤œç´¢æ–‡å­—">
  <input type="text" id="replaceWith" placeholder="ç½®æ›æ–‡å­—">
  <button onclick="executeReplace()" style="background:var(--primary); color:white; border:none; padding:12px; border-radius:8px; font-weight:bold;">ä¸€æ‹¬ç½®æ›ã‚’å®Ÿè¡Œ</button>
</div>

<div id="main-view">
  <div id="right-container" class="tab-content active">
    <div id="right" contenteditable="false">ã‚¿ãƒƒãƒ—ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€ã‹ã€ç« ã‚’è¿½åŠ ã—ã¦åŸ·ç­†ã‚’é–‹å§‹ã—ã¦ãã ã•ã„ã€‚</div>
  </div>
  <div id="left" class="tab-content">
    <button class="menu-btn" onclick="document.getElementById('fileInput').click()">ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€ (PDF/TXT/HTML)</button>
    <button class="menu-btn" onclick="addChapterMobile()">ï¼‹ æ–°ã—ã„ç« ã‚’è¿½åŠ </button>
    <button class="menu-btn" style="background:#67c23a; color:white; border:none;" onclick="saveData()">ğŸ’¾ åå‰ã‚’ä»˜ã‘ã¦ä¿å­˜</button>
    <div style="padding: 10px 15px 5px; font-size: 12px; color: #909399;">ã‚¢ãƒ³ã‚«ãƒ¼è¿½åŠ å…ˆï¼š</div>
    <select id="chapterSelect" class="menu-btn"></select>
    <div id="chapters"></div>
  </div>
</div>

<div id="toast-container"></div>
<input type="file" id="fileInput" style="display:none;" accept=".html,.txt,.pdf">
<button id="float-btn">ğŸ”– é¸æŠç¯„å›²ã‚’ã‚¢ãƒ³ã‚«ãƒ¼ã«ã™ã‚‹</button>

<nav id="nav">
  <button class="nav-item active" onclick="switchTab('right-container', this)">ğŸ“– æœ¬æ–‡</button>
  <button class="nav-item" onclick="switchTab('left', this)">ğŸ”– ç®¡ç†</button>
</nav>

<script>
pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

const right = document.getElementById('right');
const chapterSelect = document.getElementById('chapterSelect');
const floatBtn = document.getElementById('float-btn');
const themeToggle = document.getElementById('themeToggle');

// ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥æ©Ÿèƒ½
function showToast(msg, isError = false) {
  const container = document.getElementById('toast-container');
  const t = document.createElement('div');
  t.className = 'toast' + (isError ? ' error' : '');
  t.innerText = msg;
  container.appendChild(t);
  setTimeout(() => t.classList.add('show'), 10);
  setTimeout(() => { t.classList.remove('show'); setTimeout(() => t.remove(), 300); }, 2500);
}

// ãƒ†ãƒ¼ãƒ
themeToggle.onclick = () => {
  const isDark = document.body.getAttribute('data-theme') === 'dark';
  document.body.setAttribute('data-theme', isDark ? '' : 'dark');
  themeToggle.innerText = isDark ? 'ğŸŒ™' : 'â˜€ï¸';
};

// ã‚¿ãƒ–
function switchTab(id, btn) {
  document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  btn.classList.add('active');
  floatBtn.style.display = 'none';
}

// è‡ªç”±ç·¨é›†
function toggleEdit(isStart) {
  right.contentEditable = isStart ? "true" : "false";
  document.getElementById('editBtn').style.display = isStart ? "none" : "block";
  document.getElementById('finishBtn').style.display = isStart ? "block" : "none";
  document.getElementById('replacePanel').style.display = isStart ? "flex" : "none";
  if (!isStart) {
    const broken = syncAnchorText();
    if (broken.length > 0 && confirm(`${broken.length}å€‹ã®ã‚¢ãƒ³ã‚«ãƒ¼ãŒç ´æã—ã¾ã—ãŸã€‚å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
      broken.forEach(anc => anc.remove());
    }
    showToast("âœ… ç·¨é›†ã‚’åæ˜ ã—ã¾ã—ãŸ");
  }
}

function syncAnchorText() {
  const broken = [];
  document.querySelectorAll('.anchor').forEach(anc => {
    const target = right.querySelector(`span[data-block-id="${anc.dataset.bid}"]`);
    if (target) {
      const text = target.innerText.trim() || "(ç©º)";
      anc.querySelector('.anchor-txt').innerText = text.slice(0, 15) + (text.length > 15 ? "..." : "");
    } else { broken.push(anc); }
  });
  return broken;
}

function executeReplace() {
  const find = document.getElementById('findText').value;
  const replace = document.getElementById('replaceWith').value;
  if (!find) return;
  if (confirm(`ã€Œ${find}ã€ã‚’ã€Œ${replace}ã€ã«ç½®æ›ã—ã¾ã™ã‹ï¼Ÿ`)) {
    const regex = new RegExp(find.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'g');
    right.innerHTML = right.innerHTML.replace(regex, replace);
    syncAnchorText();
    showToast("ğŸ” ç½®æ›ã‚’å®Ÿè¡Œã—ã¾ã—ãŸ");
  }
}

// ã‚¢ãƒ³ã‚«ãƒ¼ä½œæˆï¼ˆé‡è¤‡ãƒã‚§ãƒƒã‚¯ä»˜ãï¼‰
document.addEventListener('selectionchange', () => {
  const sel = window.getSelection();
  const isActive = document.getElementById('right-container').classList.contains('active');
  if (isActive && !sel.isCollapsed && right.contentEditable === "false") {
    floatBtn.style.display = 'block';
  } else {
    setTimeout(() => { if (window.getSelection().isCollapsed) floatBtn.style.display = 'none'; }, 800);
  }
});

floatBtn.onpointerdown = (e) => {
  e.preventDefault(); e.stopPropagation();
  const sel = window.getSelection();
  if (sel.isCollapsed || !chapterSelect.options.length) return;
  
  const range = sel.getRangeAt(0);
  // ã€æ–°æ©Ÿèƒ½ã€‘é‡è¤‡ãƒã‚§ãƒƒã‚¯
  const frag = range.cloneContents();
  if (frag.querySelector('.selected-range')) {
    showToast("âš ï¸ ã™ã§ã«ã‚¢ãƒ³ã‚«ãƒ¼ãŒå«ã¾ã‚Œã¦ã„ã¾ã™", true);
    return;
  }

  const bid = 'b' + Date.now();
  const span = document.createElement('span');
  span.className = 'selected-range';
  span.dataset.blockId = bid;
  try {
    range.surroundContents(span);
    createAnchorElement(bid, span.innerText, chapterSelect.value);
    showToast("ğŸ”— ã‚¢ãƒ³ã‚«ãƒ¼ã‚’ä½œæˆã—ã¾ã—ãŸ");
    sel.removeAllRanges();
  } catch (err) { alert("æ”¹è¡Œã‚’è·¨ããªã©ã®è¤‡é›‘ãªç¯„å›²ã¯é¸æŠã§ãã¾ã›ã‚“ã€‚"); }
};

// ç« ã®ç®¡ç†
function createChapter(name, existingId = null) {
  const id = existingId || 'c' + Date.now();
  const chap = document.createElement('div');
  chap.className = 'chapter';
  chap.innerHTML = `
    <div class="chapter-title" onclick="toggleChapter('${id}', this)">
      <div><span class="toggle-icon">â–¼</span><span>${name}</span></div>
      <button class="del-btn" onclick="event.stopPropagation(); deleteChapter('${id}')">Ã—</button>
    </div>
    <div class="chapter-anchors" id="${id}"></div>`;
  document.getElementById('chapters').appendChild(chap);
  const opt = document.createElement('option');
  opt.value = id; opt.innerText = name;
  chapterSelect.appendChild(opt);
  chapterSelect.value = id;
  return id;
}

function toggleChapter(id, el) {
  const anchors = document.getElementById(id);
  const icon = el.querySelector('.toggle-icon');
  const isCollapsed = anchors.classList.toggle('collapsed');
  icon.innerText = isCollapsed ? 'â–¶' : 'â–¼';
}

function addChapterMobile() {
  const name = prompt("ç« ã®åå‰:", "æ–°ã—ã„ç« ");
  if (name) { createChapter(name); showToast("ğŸ“ ç« ã‚’è¿½åŠ ã—ã¾ã—ãŸ"); }
}

function deleteChapter(id) {
  if (confirm("ç« ã¨ã‚¢ãƒ³ã‚«ãƒ¼ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
    const container = document.getElementById(id);
    container.querySelectorAll('.anchor').forEach(anc => deleteAnchorLogic(anc.dataset.bid));
    container.parentElement.remove();
    Array.from(chapterSelect.options).find(o => o.value === id).remove();
    showToast("ğŸ—‘ï¸ ç« ã‚’å‰Šé™¤ã—ã¾ã—ãŸ");
  }
}

function createAnchorElement(bid, text, targetId) {
  const container = document.getElementById(targetId);
  const anc = document.createElement('div');
  anc.className = 'anchor';
  anc.dataset.bid = bid;
  anc.innerHTML = `<span class="anchor-txt">${text.slice(0,15)}...</span><button class="del-btn">Ã—</button>`;
  container.appendChild(anc);
  anc.onclick = (e) => {
    if (e.target.classList.contains('del-btn')) {
      deleteAnchorLogic(bid); anc.remove();
      showToast("ğŸ—‘ï¸ ã‚¢ãƒ³ã‚«ãƒ¼ã‚’å‰Šé™¤ã—ã¾ã—ãŸ");
    } else {
      switchTab('right-container', document.querySelector('.nav-item'));
      setTimeout(() => {
        const target = right.querySelector(`span[data-block-id="${bid}"]`);
        if (target) target.scrollIntoView({ behavior: "smooth", block: "center" });
      }, 300);
    }
  };
}

function deleteAnchorLogic(bid) {
  const target = right.querySelector(`span[data-block-id="${bid}"]`);
  if (target) {
    const p = target.parentNode;
    while (target.firstChild) p.insertBefore(target.firstChild, target);
    p.removeChild(target);
  }
}

// ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ (PDF HAMU Rule)
document.getElementById('fileInput').onchange = async e => {
  const file = e.target.files[0];
  if (!file) return;
  showToast(`ğŸ“„ ${file.name} ã‚’èª­ã¿è¾¼ã¿ä¸­...`);
  const reader = new FileReader();
  if (file.type === "application/pdf") {
    reader.readAsArrayBuffer(file);
    reader.onload = async ev => {
      const pdf = await pdfjsLib.getDocument({data: ev.target.result}).promise;
      let fullText = "";
      for (let i = 1; i <= pdf.numPages; i++) {
        const page = await pdf.getPage(i);
        const content = await page.getTextContent();
        let lastY = -1;
        for (let item of content.items) {
          if (lastY !== -1 && Math.abs(item.transform[5] - lastY) > 5) fullText += "\n";
          fullText += item.str; lastY = item.transform[5];
        }
        fullText += "\n";
      }
      right.innerText = cleanPdfText(fullText);
      showToast("âœ… PDFã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ");
    };
  } else {
    reader.readAsText(file);
    reader.onload = ev => {
      const content = ev.target.result.normalize('NFC');
      const parser = new DOMParser();
      const doc = parser.parseFromString(content, 'text/html');
      const savedRight = doc.getElementById('right');
      if (savedRight) {
        right.innerHTML = savedRight.innerHTML;
        document.getElementById('chapters').innerHTML = "";
        chapterSelect.innerHTML = "";
        doc.getElementById('chapters').querySelectorAll('.chapter').forEach(oldChap => {
          const name = (oldChap.querySelector('.chapter-title div span:last-child') || {innerText:"ç« "}).innerText;
          const newId = createChapter(name, oldChap.querySelector('.chapter-anchors').id);
          oldChap.querySelectorAll('.anchor').forEach(oldAnc => {
            createAnchorElement(oldAnc.dataset.bid, oldAnc.querySelector('.anchor-txt').innerText, newId);
          });
        });
        showToast("âœ… ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å¾©å…ƒã—ã¾ã—ãŸ");
      } else { right.innerText = content; showToast("âœ… ãƒ†ã‚­ã‚¹ãƒˆã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ"); }
    };
  }
};

function cleanPdfText(text) {
  text = text.normalize("NFC");
  let tempText = text.replace(/\n\s*\n/g, "[[PARA_BREAK]]");
  let rawLines = tempText.split('\n');
  let result = "";
  for (let line of rawLines) {
    let trimmed = line.trim(); if (!trimmed) continue;
    let last = result.split('\n').pop();
    let isEnd = /[ã€‚ï¼ï¼Ÿ!?â€¦â”€]/.test(last.slice(-1));
    let isIndent = /^[ ã€€]/.test(line);
    let isSym = /^[^ã‚-ã‚“ã‚¢-ãƒ³ä¸€-é¾ \s]/.test(trimmed) || /^[\dï¼-ï¼™]/.test(trimmed);
    let isShort = last.length > 0 && last.length <= 10;
    if (isEnd || isIndent || isSym || isShort || result === "") {
      result += (result === "" ? "" : "\n") + trimmed;
    } else {
      result += trimmed.replace(/\t/g, "").replace(/([ã‚-ã‚“ã‚¢-ãƒ³ä¸€-é¾ ])\s+([ã‚-ã‚“ã‚¢-ãƒ³ä¸€-é¾ ])/g, '$1$2');
    }
  }
  return result.replace(/\[\[PARA_BREAK\]\]/g, "\n\n");
}

function saveData() {
  const fileName = prompt("ä¿å­˜å:", "scenario");
  if (!fileName) return;
  const htmlContent = "<!DOCTYPE html>\n" + document.documentElement.outerHTML;
  const blob = new Blob([new Uint8Array([0xEF, 0xBB, 0xBF]), htmlContent], { type: 'text/html' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob); a.download = fileName + '.html'; a.click();
  showToast("ğŸ’¾ ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜ã—ã¾ã—ãŸ");
}

window.onload = () => { if (!chapterSelect.options.length) createChapter('ç« 1'); };
</script>
</body>
</html>
