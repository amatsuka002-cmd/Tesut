<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>HALUDAKE Mobile v5</title>
<style>
:root { --primary: #409eff; --danger: #f56c6c; --bg: #ffffff; --text: #2c3e50; --border: #dcdfe6; }
body { margin: 0; font-family: sans-serif; height: 100dvh; display: flex; flex-direction: column; overflow: hidden; background: #f4f7f9; }

/* ãƒ¡ã‚¤ãƒ³è¡¨ç¤ºã‚¨ãƒªã‚¢ */
#main-view { flex: 1; overflow: hidden; display: flex; flex-direction: column; }
.tab-content { display: none; height: 100%; overflow-y: auto; background: var(--bg); -webkit-overflow-scrolling: touch; }
.tab-content.active { display: block; }

/* æœ¬æ–‡ã‚¨ãƒªã‚¢ */
#right { padding: 20px 15px 180px; line-height: 1.8; font-size: 17px; white-space: pre-wrap; word-break: break-all; min-height: 100%; color: var(--text); }
.load-guide { border: 3px dashed var(--border); margin: 20px; padding: 40px 20px; text-align: center; border-radius: 15px; color: #909399; cursor: pointer; }
.selected-range { background-color: rgba(64, 158, 255, 0.3); border-bottom: 2px solid var(--primary); }

/* ä¸‹éƒ¨ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ */
#nav { height: 70px; background: #333; display: flex; justify-content: space-around; align-items: center; z-index: 2000; padding-bottom: env(safe-area-inset-bottom); }
.nav-item { color: #ccc; font-size: 11px; text-align: center; border: none; background: none; flex: 1; display: flex; flex-direction: column; align-items: center; }
.nav-item.active { color: var(--primary); font-weight: bold; }
.nav-icon { font-size: 22px; margin-bottom: 2px; }

/* ã€ä¿®æ­£ã€‘ã‚¢ãƒ³ã‚«ãƒ¼ä½œæˆãƒœã‚¿ãƒ³ï¼šç”»é¢ä¸‹éƒ¨ã«å¤§ããå›ºå®š */
#float-btn {
  display: none; position: fixed; 
  bottom: 85px; left: 15px; right: 15px; /* ãƒŠãƒ“ãƒãƒ¼ã®ã™ãä¸Š */
  z-index: 4000; background: var(--primary);
  color: white; padding: 18px; border-radius: 12px; font-weight: bold;
  box-shadow: 0 -4px 15px rgba(0,0,0,0.2); border: none; font-size: 18px;
  user-select: none; -webkit-user-select: none;
}

/* ç« ãƒ»ã‚¢ãƒ³ã‚«ãƒ¼ç®¡ç† */
.chapter { border: 1px solid var(--border); margin: 10px; border-radius: 8px; background: #fff; overflow: hidden; }
.chapter-title { padding: 12px 15px; background: #f9f9f9; display: flex; justify-content: space-between; align-items: center; font-weight: bold; border-bottom: 1px solid var(--border); }
.anchor { display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; border-bottom: 1px solid #eee; background: #fff; }
.anchor-txt { flex: 1; font-size: 14px; color: #444; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; padding-right: 10px; }
.del-btn { color: var(--danger); font-size: 20px; padding: 5px 10px; border: none; background: none; font-weight: bold; }

/* æ“ä½œãƒœã‚¿ãƒ³ */
.menu-btn { width: calc(100% - 30px); margin: 10px 15px; padding: 15px; border-radius: 10px; border: 1px solid var(--border); font-size: 16px; background: white; font-weight: bold; }
#saveFileBtn { background: #67c23a; color: white; border: none; }
#chapterSelect { width: calc(100% - 30px); margin: 5px 15px 15px; padding: 12px; border-radius: 8px; border: 1px solid var(--border); font-size: 16px; background: #fff; }
</style>
</head>
<body>

<div id="main-view">
  <div id="right-container" class="tab-content active">
    <div id="right">
      <div class="load-guide" onclick="document.getElementById('fileInput').click()">
        <span style="font-size: 40px;">ğŸ“</span><br>ã‚¿ãƒƒãƒ—ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€
      </div>
    </div>
  </div>

  <div id="left" class="tab-content">
    <div style="padding-top: 15px;">
      <button class="menu-btn" onclick="addChapterMobile()">ï¼‹ æ–°ã—ã„ç« ã‚’è¿½åŠ </button>
      <button id="saveFileBtn" class="menu-btn" onclick="saveData()">ğŸ’¾ åå‰ã‚’ä»˜ã‘ã¦ä¿å­˜</button>
      <div style="padding: 5px 15px;"><label style="font-size:12px; color:#666;">ã‚¢ãƒ³ã‚«ãƒ¼ã®è¿½åŠ å…ˆï¼š</label></div>
      <select id="chapterSelect"></select>
    </div>
    <div id="chapters"></div>
  </div>
</div>

<input type="file" id="fileInput" style="display:none;" accept=".html,.txt">
<button id="float-btn">ğŸ”– é¸æŠç¯„å›²ã‚’ã‚¢ãƒ³ã‚«ãƒ¼ã«ã™ã‚‹</button>

<nav id="nav">
  <button class="nav-item active" onclick="switchTab('right-container', this)">
    <span class="nav-icon">ğŸ“–</span>æœ¬æ–‡
  </button>
  <button class="nav-item" onclick="switchTab('left', this)">
    <span class="nav-icon">ğŸ”–</span>ç®¡ç†
  </button>
</nav>

<script>
const right = document.getElementById('right');
const chapterSelect = document.getElementById('chapterSelect');
const floatBtn = document.getElementById('float-btn');

function switchTab(id, btn) {
  document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  btn.classList.add('active');
  floatBtn.style.display = 'none';
}

// é¸æŠä¸­ã®è¡¨ç¤ºåˆ¶å¾¡
document.addEventListener('selectionchange', () => {
  const sel = window.getSelection();
  // æœ¬æ–‡ã‚¿ãƒ–ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹æ™‚ã ã‘ãƒœã‚¿ãƒ³ã‚’å‡ºã™
  const isActive = document.getElementById('right-container').classList.contains('active');
  
  if (isActive && !sel.isCollapsed && sel.toString().trim().length > 0) {
    floatBtn.style.display = 'block';
  } else {
    // ã™ãã«æ¶ˆã™ã¨ã‚¿ãƒƒãƒ—ã§ããªã„ã®ã§ã€å°‘ã—ã ã‘çŒ¶äºˆã‚’æŒãŸã›ã‚‹
    setTimeout(() => {
      if (window.getSelection().isCollapsed) floatBtn.style.display = 'none';
    }, 800);
  }
});

// ã‚¢ãƒ³ã‚«ãƒ¼ä½œæˆï¼ˆæŒ‡ãŒè§¦ã‚ŒãŸç¬é–“ã«ç¾åœ¨ã®é¸æŠã‚’ç¢ºå®šã•ã›ã‚‹ï¼‰
floatBtn.onpointerdown = (e) => {
  e.preventDefault();
  e.stopPropagation();

  const sel = window.getSelection();
  if (sel.isCollapsed || sel.toString().trim().length === 0) {
    alert("æ–‡å­—ã‚’é¸æŠã—ã¦ã‹ã‚‰æŠ¼ã—ã¦ãã ã•ã„");
    return;
  }
  
  if (chapterSelect.options.length === 0) {
    alert("ã€Œç®¡ç†ã€ã‚¿ãƒ–ã§ç« ã‚’ä½œæˆã—ã¦ãã ã•ã„");
    return;
  }

  const range = sel.getRangeAt(0);
  // æœ¬æ–‡ä»¥å¤–ã‚’é¸ã‚“ã§ã„ãªã„ã‹ãƒã‚§ãƒƒã‚¯
  if (!right.contains(range.commonAncestorContainer)) {
    alert("æœ¬æ–‡ã‚¨ãƒªã‚¢ã®æ–‡å­—ã‚’é¸æŠã—ã¦ãã ã•ã„");
    return;
  }

  const bid = 'b' + Date.now();
  const span = document.createElement('span');
  span.className = 'selected-range';
  span.dataset.blockId = bid;

  try {
    range.surroundContents(span);
    createAnchorElement(bid, span.innerText, chapterSelect.value);
    
    floatBtn.style.display = 'none';
    sel.removeAllRanges();
  } catch (err) {
    alert("æ”¹è¡Œã‚’ã¾ãŸãç¯„å›²ãªã©ã¯é¸æŠã§ãã¾ã›ã‚“ã€‚");
  }
};

function createChapter(name, existingId = null) {
  const id = existingId || 'c' + Date.now();
  const chap = document.createElement('div');
  chap.className = 'chapter';
  chap.innerHTML = `<div class="chapter-title"><span class="title-txt">${name}</span><button class="del-btn">Ã—</button></div><div class="chapter-anchors" id="${id}"></div>`;
  document.getElementById('chapters').appendChild(chap);
  const opt = document.createElement('option');
  opt.value = id; opt.innerText = name; chapterSelect.appendChild(opt);
  chap.querySelector('.del-btn').onclick = () => {
    if (confirm("ç« ã¨ã‚¢ãƒ³ã‚«ãƒ¼ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
      chap.querySelectorAll('.anchor').forEach(anc => deleteAnchorLogic(anc.dataset.bid));
      chap.remove(); opt.remove();
    }
  };
  return id;
}

function addChapterMobile() {
  const name = prompt("ç« ã®åå‰:", "æ–°ã—ã„ç« ");
  if (name) createChapter(name);
}

function createAnchorElement(bid, text, targetId) {
  const container = document.getElementById(targetId);
  if (!container) return;
  const anc = document.createElement('div');
  anc.className = 'anchor';
  anc.dataset.bid = bid;
  anc.innerHTML = `<span class="anchor-txt">${text.slice(0,15)}...</span><button class="del-btn">Ã—</button>`;
  container.appendChild(anc);
  anc.onclick = (e) => {
    if (e.target.classList.contains('del-btn')) {
      deleteAnchorLogic(bid); anc.remove();
    } else {
      switchTab('right-container', document.querySelector('.nav-item'));
      setTimeout(() => {
        const target = right.querySelector(`span[data-block-id="${bid}"]`);
        if (target) target.scrollIntoView({ behavior: "smooth", block: "center" });
      }, 200);
    }
  };
}

function deleteAnchorLogic(bid) {
  const targetSpan = right.querySelector(`span[data-block-id="${bid}"]`);
  if (targetSpan) {
    const parent = targetSpan.parentNode;
    while (targetSpan.firstChild) parent.insertBefore(targetSpan.firstChild, targetSpan);
    parent.removeChild(targetSpan);
  }
}

document.getElementById('fileInput').onchange = e => {
  const file = e.target.files[0];
  const reader = new FileReader();
  reader.readAsText(file);
  reader.onload = ev => {
    const content = ev.target.result.normalize('NFC');
    const parser = new DOMParser();
    const doc = parser.parseFromString(content, 'text/html');
    const savedRight = doc.getElementById('right');
    const savedChapters = doc.getElementById('chapters');
    if (savedRight && savedChapters) {
      right.innerHTML = savedRight.innerHTML;
      document.getElementById('chapters').innerHTML = "";
      chapterSelect.innerHTML = "";
      const tempDiv = document.createElement('div');
      tempDiv.innerHTML = savedChapters.innerHTML;
      tempDiv.querySelectorAll('.chapter').forEach(oldChap => {
        const name = oldChap.querySelector('.title-txt').innerText;
        const newId = createChapter(name, oldChap.querySelector('.chapter-anchors').id);
        oldChap.querySelectorAll('.anchor').forEach(oldAnc => {
          createAnchorElement(oldAnc.dataset.bid, oldAnc.querySelector('.anchor-txt').innerText, newId);
        });
      });
    } else {
      right.innerText = content;
      if (chapterSelect.options.length === 0) createChapter('ç« 1');
    }
  };
};

function saveData() {
  const fileName = prompt("ä¿å­˜å:", "scenario");
  if (!fileName) return;
  const htmlContent = "<!DOCTYPE html>\n" + document.documentElement.outerHTML;
  const blob = new Blob([new Uint8Array([0xEF, 0xBB, 0xBF]), htmlContent], { type: 'text/html' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob); a.download = fileName + '.html'; a.click();
}

window.onload = () => { if (!chapterSelect.options.length) createChapter('ç« 1'); };
</script>
</body>
</html>
