<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<title>HALUDAKE Mobile - Complete</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<style>
:root { --primary: #409eff; --danger: #f56c6c; --bg: #ffffff; --text: #2c3e50; --border: #dcdfe6; --app-bg: #f4f7f9; }
[data-theme="dark"] { --bg: #2d2d2d; --text: #e0e0e0; --border: #444444; --app-bg: #1a1a1a; }

body { margin: 0; font-family: sans-serif; height: 100dvh; display: flex; flex-direction: column; overflow: hidden; background: var(--app-bg); color: var(--text); }

/* ã‚¿ãƒ–è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ */
#main-view { flex: 1; overflow: hidden; display: flex; flex-direction: column; position: relative; }
.tab-content { display: none; height: 100%; overflow-y: auto; background: var(--bg); }
.tab-content.active { display: block; }

/* æœ¬æ–‡ã‚¨ãƒªã‚¢ */
#right { padding: 30px 15px 150px; line-height: 1.8; font-size: 17px; white-space: pre-wrap; word-break: break-all; outline: none; min-height: 100%; }
.selected-range { background-color: rgba(64, 158, 255, 0.2); border-bottom: 2px solid var(--primary); }

/* æµ®ãå‡ºã‚‹ã‚¢ãƒ³ã‚«ãƒ¼ãƒœã‚¿ãƒ³ */
#float-btn {
  display: none; position: fixed; z-index: 4000; background: var(--primary);
  color: white; padding: 12px 22px; border-radius: 30px; font-weight: bold;
  box-shadow: 0 4px 15px rgba(0,0,0,0.3); border: none; font-size: 15px;
}

/* ç®¡ç†ç”»é¢UI */
.menu-section { padding: 15px; border-bottom: 1px solid var(--border); }
.btn { width: 100%; padding: 12px; margin: 5px 0; border-radius: 8px; border: 1px solid var(--border); font-size: 15px; background: var(--bg); color: var(--text); font-weight: bold; }
#saveFileBtn { background: #67c23a; color: white; border: none; }
.load-guide { border: 2px dashed var(--border); padding: 30px; text-align: center; border-radius: 12px; margin: 10px; color: #909399; }

/* ç« ãƒ»ã‚¢ãƒ³ã‚«ãƒ¼è¡¨ç¤º */
.chapter { border: 1px solid var(--border); margin: 10px; border-radius: 8px; background: var(--bg); }
.chapter-title { padding: 12px; background: rgba(0,0,0,0.03); display: flex; justify-content: space-between; align-items: center; font-weight: bold; }
.anchor { display: flex; justify-content: space-between; align-items: center; padding: 12px; border-top: 1px solid var(--border); font-size: 14px; }
.anchor-txt { flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.del-icon { color: var(--danger); font-size: 18px; padding: 0 10px; }

/* ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ */
#nav { height: 75px; background: #2d2d2d; display: flex; justify-content: space-around; align-items: center; z-index: 2000; padding-bottom: env(safe-area-inset-bottom); }
.nav-item { color: #888; font-size: 11px; text-align: center; border: none; background: none; flex: 1; height: 100%; }
.nav-item.active { color: var(--primary); font-weight: bold; }
.nav-icon { font-size: 24px; display: block; margin-top: 5px; }

/* ç·¨é›†ãƒ‘ãƒãƒ« */
#edit-panel { position: fixed; top: 10px; right: 10px; display: flex; gap: 5px; z-index: 3000; }
.mini-btn { padding: 8px 12px; border-radius: 20px; border: 1px solid var(--border); background: var(--bg); font-size: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
</style>
</head>
<body>

<div id="edit-panel">
    <button id="themeBtn" class="mini-btn">ğŸŒ™</button>
    <button id="editBtn" class="mini-btn">âœ ç·¨é›†</button>
    <button id="finishBtn" class="mini-btn" style="display:none; background:var(--primary); color:white;">âœ“ å®Œäº†</button>
</div>

<div id="main-view">
  <div id="tab-right" class="tab-content active">
    <div id="right" contenteditable="false">
        <div class="load-guide" onclick="document.getElementById('fileInput').click()">
            <span style="font-size:30px;">ğŸ“</span><br>ã‚¿ãƒƒãƒ—ã—ã¦èª­ã¿è¾¼ã¿<br>(HTML/TXT/PDF)
        </div>
    </div>
  </div>

  <div id="tab-left" class="tab-content">
    <div class="menu-section">
      <button class="btn" onclick="addChapterMobile()">ï¼‹ æ–°ã—ã„ç« ã‚’è¿½åŠ </button>
      <button id="saveFileBtn" class="btn">ğŸ’¾ ä¿å­˜</button>
      <select id="chapterSelect" class="btn"></select>
    </div>
    <div id="chapters"></div>
  </div>
</div>

<input type="file" id="fileInput" style="display:none;" accept=".html,.txt,.pdf">
<button id="float-btn">ğŸ”– ã‚¢ãƒ³ã‚«ãƒ¼ã‚’ä½œæˆ</button>

<nav id="nav">
  <button class="nav-item active" onclick="switchTab('tab-right', this)">
    <span class="nav-icon">ğŸ“–</span>æœ¬æ–‡
  </button>
  <button class="nav-item" onclick="switchTab('tab-left', this)">
    <span class="nav-icon">ğŸ”–</span>ç®¡ç†
  </button>
</nav>

<script>
pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

const right = document.getElementById('right');
const chapterSelect = document.getElementById('chapterSelect');
const floatBtn = document.getElementById('float-btn');
const themeBtn = document.getElementById('themeBtn');
const editBtn = document.getElementById('editBtn');
const finishBtn = document.getElementById('finishBtn');

// --- åŸºæœ¬ãƒ­ã‚¸ãƒƒã‚¯ ---

function switchTab(id, btn) {
  document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  btn.classList.add('active');
  floatBtn.style.display = 'none';
}

themeBtn.onclick = () => {
  const isDark = document.body.getAttribute('data-theme') === 'dark';
  document.body.setAttribute('data-theme', isDark ? '' : 'dark');
  themeBtn.innerText = isDark ? 'ğŸŒ™' : 'â˜€ï¸';
};

editBtn.onclick = () => {
  right.contentEditable = "true"; right.focus();
  editBtn.style.display = "none"; finishBtn.style.display = "block";
};

finishBtn.onclick = () => {
  const broken = syncAnchorText();
  if (broken.length > 0) {
    if (confirm(`${broken.length} å€‹ã®ã‚¢ãƒ³ã‚«ãƒ¼ãŒç ´æã—ã¾ã—ãŸã€‚å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
        broken.forEach(anc => anc.remove());
    }
  }
  right.querySelectorAll('.selected-range').forEach(span => { if (!span.innerText.trim()) span.remove(); });
  right.contentEditable = "false"; editBtn.style.display = "block"; finishBtn.style.display = "none";
};

function syncAnchorText() {
  const broken = [];
  document.querySelectorAll('.anchor').forEach(anc => {
    const target = right.querySelector(`span[data-block-id="${anc.dataset.bid}"]`);
    if (target) {
      const txt = target.innerText.trim() || "(ç©º)";
      anc.querySelector('.anchor-txt').innerText = txt.slice(0, 20) + (txt.length > 20 ? "..." : "");
    } else { broken.push(anc); }
  });
  return broken;
}

// --- æµ®ãå‡ºã‚‹ã‚¢ãƒ³ã‚«ãƒ¼ä½œæˆãƒœã‚¿ãƒ³ ---

document.addEventListener('selectionchange', () => {
  const sel = window.getSelection();
  if (!sel.isCollapsed && sel.toString().trim().length > 0 && document.getElementById('tab-right').classList.contains('active')) {
    const rect = sel.getRangeAt(0).getBoundingClientRect();
    floatBtn.style.display = 'block';
    floatBtn.style.top = (rect.bottom + 15) + 'px';
    floatBtn.style.left = Math.max(10, (rect.left + rect.width / 2 - 80)) + 'px';
  }
});

document.addEventListener('touchstart', (e) => {
  if (e.target !== floatBtn) setTimeout(() => { if(window.getSelection().isCollapsed) floatBtn.style.display = 'none'; }, 200);
});

floatBtn.onclick = (e) => {
  e.preventDefault();
  if (chapterSelect.options.length === 0) { alert("ç« ã‚’ä½œæˆã—ã¦ãã ã•ã„"); return; }
  const sel = window.getSelection();
  const range = sel.getRangeAt(0);
  const bid = 'b' + Date.now();
  const span = document.createElement('span');
  span.className = 'selected-range'; span.dataset.blockId = bid;
  try {
    range.surroundContents(span);
    createAnchorElement(bid, span.innerText, chapterSelect.value);
    sel.removeAllRanges();
    floatBtn.style.display = 'none';
  } catch (err) { alert("è¤‡é›‘ãªç¯„å›²ã¯é¸æŠã§ãã¾ã›ã‚“ã€‚"); }
};

// --- ç« ãƒ»ã‚¢ãƒ³ã‚«ãƒ¼ç®¡ç†ãƒ­ã‚¸ãƒƒã‚¯ (PCç‰ˆå®Œå…¨ç§»æ¤) ---

function createChapter(name, existingId = null) {
  const id = existingId || 'c' + Date.now();
  const chap = document.createElement('div');
  chap.className = 'chapter';
  chap.innerHTML = `<div class="chapter-title"><span class="title-txt">${name}</span><span class="del-icon">Ã—</span></div><div class="chapter-anchors" id="${id}"></div>`;
  document.getElementById('chapters').appendChild(chap);
  
  const opt = document.createElement('option');
  opt.value = id; opt.innerText = name; chapterSelect.appendChild(opt);
  
  chap.querySelector('.del-icon').onclick = (e) => {
    e.stopPropagation();
    if(confirm("ç« ã¨ã‚¢ãƒ³ã‚«ãƒ¼ã‚’ã™ã¹ã¦å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
      chap.querySelectorAll('.anchor').forEach(anc => deleteAnchorLogic(anc.dataset.bid));
      chap.remove(); opt.remove();
    }
  };
  return id;
}

function createAnchorElement(bid, text, targetId) {
  const container = document.getElementById(targetId);
  if(!container) return;
  const anc = document.createElement('div');
  anc.className = 'anchor'; anc.dataset.bid = bid;
  anc.innerHTML = `<span class="anchor-txt">${text.slice(0,20)}...</span><span class="del-icon">Ã—</span>`;
  container.appendChild(anc);
  
  anc.onclick = (e) => {
    if(e.target.classList.contains('del-icon')) {
      deleteAnchorLogic(bid); anc.remove();
    } else {
      switchTab('tab-right', document.querySelector('.nav-item'));
      setTimeout(() => {
        const target = right.querySelector(`span[data-block-id="${bid}"]`);
        if(target) target.scrollIntoView({ behavior: "smooth", block: "center" });
      }, 150);
    }
  };
}

function deleteAnchorLogic(bid) {
  const target = right.querySelector(`span[data-block-id="${bid}"]`);
  if (target) {
    const p = target.parentNode;
    while (target.firstChild) p.insertBefore(target.firstChild, target);
    p.removeChild(target);
  }
}

function addChapterMobile() {
  const name = prompt("ç« ã®åå‰:", "æ–°ã—ã„ç« ");
  if(name) createChapter(name);
}

// --- PDFãƒ»ãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç† (PCç‰ˆã®æ•´å½¢ãƒ«ãƒ¼ãƒ«ã‚’ç¶­æŒ) ---

function cleanPdfText(text) {
  text = text.normalize("NFC");
  let rawLines = text.replace(/\n\s*\n/g, "[[PARA]]").split('\n');
  let result = "";
  for (let line of rawLines) {
    let trimmed = line.trim();
    if (!trimmed) continue;
    let lastLine = result.split('\n').pop();
    let prevEnd = /[ã€‚ï¼ï¼Ÿ!?â€¦â”€]/.test(lastLine.slice(-1));
    let isIndent = /^[ ã€€]/.test(line);
    let isSpec = /^[^ã‚-ã‚“ã‚¢-ãƒ³ä¸€-é¾ \s]/.test(trimmed) || /^[\dï¼-ï¼™]/.test(trimmed);
    let wasShort = lastLine.length > 0 && lastLine.length <= 10;
    
    if (prevEnd || isIndent || isSpec || wasShort || line.includes("[[PARA]]") || result === "") {
      result += (result === "" ? "" : "\n") + trimmed;
    } else {
      result += trimmed.replace(/\t/g, "").replace(/([ã‚-ã‚“ã‚¢-ãƒ³ä¸€-é¾ ])\s+([ã‚-ã‚“ã‚¢-ãƒ³ä¸€-é¾ ])/g, '$1$2');
    }
  }
  return result.replace(/\[\[PARA\]\]/g, "\n\n").trim();
}

async function extractPdfText(data) {
  const pdf = await pdfjsLib.getDocument({data: data}).promise;
  let full = "";
  for (let i = 1; i <= pdf.numPages; i++) {
    const page = await pdf.getPage(i);
    const content = await page.getTextContent();
    let lastY = -1; let pageText = "";
    for (let item of content.items) {
      if (lastY !== -1 && Math.abs(item.transform[5] - lastY) > 5) pageText += "\n";
      pageText += item.str; lastY = item.transform[5];
    }
    full += pageText + "\n";
  }
  return cleanPdfText(full);
}

document.getElementById('fileInput').onchange = e => {
  const file = e.target.files[0];
  const reader = new FileReader();
  if (file.type === "application/pdf" || file.name.endsWith(".pdf")) {
    reader.readAsArrayBuffer(file);
    reader.onload = async ev => { right.innerText = await extractPdfText(ev.target.result); };
  } else {
    reader.readAsText(file);
    reader.onload = ev => {
      const doc = new DOMParser().parseFromString(ev.target.result, 'text/html');
      const sRight = doc.getElementById('right');
      const sChaps = doc.getElementById('chapters');
      if (sRight && sChaps) {
        right.innerHTML = sRight.innerHTML;
        document.getElementById('chapters').innerHTML = ""; chapterSelect.innerHTML = "";
        const temp = document.createElement('div'); temp.innerHTML = sChaps.innerHTML;
        temp.querySelectorAll('.chapter').forEach(old => {
          const nid = createChapter(old.querySelector('.title-txt').innerText, old.querySelector('.chapter-anchors').id);
          old.querySelectorAll('.anchor').forEach(a => createAnchorElement(a.dataset.bid, a.querySelector('.anchor-txt').innerText, nid));
        });
      } else { right.innerText = ev.target.result; }
    };
  }
};

document.getElementById('saveFileBtn').onclick = () => {
  let name = prompt("ä¿å­˜å:", "scenario_mobile");
  if (!name) return;
  const blob = new Blob([new Uint8Array([0xEF,0xBB,0xBF]), "<!DOCTYPE html>\n" + document.documentElement.outerHTML], { type: 'text/html' });
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = name + '.html'; a.click();
};

window.onload = () => { if (!document.getElementById('chapters').children.length) createChapter('ç« 1'); };
</script>
</body>
</html>
