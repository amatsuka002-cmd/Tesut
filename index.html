<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>HALUDAKE Mobile v3</title>
<style>
:root { --primary: #409eff; --danger: #f56c6c; --bg: #ffffff; --text: #2c3e50; --border: #dcdfe6; }
body { margin: 0; font-family: sans-serif; height: 100dvh; display: flex; flex-direction: column; overflow: hidden; background: #f4f7f9; }

/* ãƒ¡ã‚¤ãƒ³è¡¨ç¤º */
#main-view { flex: 1; overflow: hidden; display: flex; flex-direction: column; }
.tab-content { display: none; height: 100%; overflow-y: auto; background: var(--bg); -webkit-overflow-scrolling: touch; }
.tab-content.active { display: block; }

/* æœ¬æ–‡ã‚¨ãƒªã‚¢ */
#right { padding: 20px 15px 150px; line-height: 1.8; font-size: 17px; white-space: pre-wrap; word-break: break-all; min-height: 100%; color: var(--text); }
.load-guide { border: 3px dashed var(--border); margin: 20px; padding: 40px 20px; text-align: center; border-radius: 15px; color: #909399; }
.selected-range { background-color: rgba(64, 158, 255, 0.2); border-bottom: 2px solid var(--primary); }

/* ä¸‹éƒ¨ãƒŠãƒ“ï¼ˆiOSã®ã‚»ãƒ¼ãƒ•ã‚¨ãƒªã‚¢å¯¾å¿œï¼‰ */
#nav { height: 75px; background: #333; display: flex; justify-content: space-around; align-items: center; z-index: 2000; padding-bottom: env(safe-area-inset-bottom); }
.nav-item { color: #ccc; font-size: 12px; text-align: center; border: none; background: none; flex: 1; }
.nav-item.active { color: var(--primary); font-weight: bold; }
.nav-icon { font-size: 24px; display: block; margin-bottom: 2px; }

/* æµ®ãå‡ºã‚‹ãƒœã‚¿ãƒ³ï¼šé¸æŠã®ä¸‹ã«å‡ºã™ */
#float-btn {
  display: none; position: fixed; z-index: 4000; background: var(--primary);
  color: white; padding: 12px 20px; border-radius: 30px; font-weight: bold;
  box-shadow: 0 4px 15px rgba(0,0,0,0.3); border: none; font-size: 15px;
  -webkit-tap-highlight-color: transparent;
}

/* ç« ãƒ»ã‚¢ãƒ³ã‚«ãƒ¼ãƒªã‚¹ãƒˆ */
.chapter { border: 1px solid var(--border); margin: 10px; border-radius: 8px; background: #fff; overflow: hidden; }
.chapter-title { padding: 12px 15px; background: #f9f9f9; display: flex; justify-content: space-between; align-items: center; font-weight: bold; border-bottom: 1px solid var(--border); }
.anchor { display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; border-bottom: 1px solid #eee; background: #fff; }
.anchor-txt { flex: 1; font-size: 14px; color: #444; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.del-btn { color: var(--danger); font-size: 18px; padding: 5px 10px; border: none; background: none; font-weight: bold; }

/* ãƒœã‚¿ãƒ³é¡ */
.menu-btn { width: calc(100% - 30px); margin: 10px 15px; padding: 14px; border-radius: 10px; border: 1px solid var(--border); font-size: 15px; background: white; font-weight: bold; }
#saveFileBtn { background: #67c23a; color: white; border: none; }
#chapterSelect { width: calc(100% - 30px); margin: 5px 15px 15px; padding: 12px; border-radius: 8px; border: 1px solid var(--border); font-size: 16px; }
</style>
</head>
<body>

<div id="main-view">
  <div id="right-container" class="tab-content active">
    <div id="right">
      <div class="load-guide" onclick="document.getElementById('fileInput').click()">
        <span style="font-size: 40px;">ğŸ“</span><br>ã‚¿ãƒƒãƒ—ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€
      </div>
    </div>
  </div>

  <div id="left" class="tab-content">
    <div style="padding-top: 15px;">
      <button class="menu-btn" onclick="addChapterMobile()">ï¼‹ æ–°ã—ã„ç« ã‚’è¿½åŠ </button>
      <button id="saveFileBtn" class="menu-btn" onclick="saveData()">ğŸ’¾ åå‰ã‚’ä»˜ã‘ã¦ä¿å­˜</button>
      <div style="padding: 5px 15px;">
        <label style="font-size:12px; color:#666;">ã‚¢ãƒ³ã‚«ãƒ¼ã®è¿½åŠ å…ˆï¼š</label>
      </div>
      <select id="chapterSelect"></select>
    </div>
    <div id="chapters"></div>
  </div>
</div>

<input type="file" id="fileInput" style="display:none;" accept=".html,.txt">
<button id="float-btn">ğŸ”– ã‚¢ãƒ³ã‚«ãƒ¼ã‚’ä½œæˆ</button>

<nav id="nav">
  <button class="nav-item active" onclick="switchTab('right-container', this)">
    <span class="nav-icon">ğŸ“–</span>æœ¬æ–‡
  </button>
  <button class="nav-item" onclick="switchTab('left', this)">
    <span class="nav-icon">ğŸ”–</span>ç®¡ç†
  </button>
</nav>

<script>
const right = document.getElementById('right');
const chapterSelect = document.getElementById('chapterSelect');
const floatBtn = document.getElementById('float-btn');
let lastRange = null;

// ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
function switchTab(id, btn) {
  document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  btn.classList.add('active');
  floatBtn.style.display = 'none';
}

// é¸æŠç¯„å›²ã®ç›£è¦–
document.addEventListener('selectionchange', () => {
  const sel = window.getSelection();
  if (!sel.isCollapsed && sel.toString().trim().length > 0) {
    const range = sel.getRangeAt(0);
    // rightï¼ˆæœ¬æ–‡ï¼‰ã®ä¸­ã§ã®é¸æŠã‹ãƒã‚§ãƒƒã‚¯
    if (right.contains(range.commonAncestorContainer)) {
      lastRange = range.cloneRange();
      const rect = range.getBoundingClientRect();
      floatBtn.style.display = 'block';
      floatBtn.style.top = (rect.bottom + 15 + window.scrollY) + 'px';
      floatBtn.style.left = Math.max(10, (rect.left + rect.width / 2 - 70)) + 'px';
      return;
    }
  }
  // é¸æŠãŒç©ºãªã‚‰ã€å°‘ã—é…ã‚Œã¦ãƒœã‚¿ãƒ³ã‚’éš ã™ï¼ˆã‚¯ãƒªãƒƒã‚¯åˆ¤å®šã®ãŸã‚ï¼‰
  setTimeout(() => {
    if (window.getSelection().isCollapsed) floatBtn.style.display = 'none';
  }, 500);
});

// ã‚¢ãƒ³ã‚«ãƒ¼ä½œæˆå®Ÿè¡Œï¼ˆã“ã“ãŒä¸€ç•ªå¤§äº‹ãªä¿®æ­£ï¼‰
floatBtn.addEventListener('touchstart', (e) => {
  e.preventDefault(); // é¸æŠè§£é™¤ã‚’é˜²ã
  if (!lastRange) return;
  if (chapterSelect.options.length === 0) { alert("å…ˆã«ã€Œç®¡ç†ã€ã‚¿ãƒ–ã§ç« ã‚’ä½œã£ã¦ãã ã•ã„"); return; }

  const bid = 'b' + Date.now();
  const span = document.createElement('span');
  span.className = 'selected-range';
  span.dataset.blockId = bid;

  try {
    lastRange.surroundContents(span);
    createAnchorElement(bid, span.innerText, chapterSelect.value);
    window.getSelection().removeAllRanges();
    floatBtn.style.display = 'none';
    lastRange = null;
  } catch (err) {
    alert("è¤‡é›‘ãªç¯„å›²ã¯é¸ã¹ã¾ã›ã‚“ã€‚ä¸€è¡Œãšã¤é¸æŠã—ã¦ãã ã•ã„ã€‚");
  }
}, {passive: false});

// ç« ã®ä½œæˆï¼ˆPCç‰ˆã®ãƒ­ã‚¸ãƒƒã‚¯ï¼‰
function createChapter(name, existingId = null) {
  const id = existingId || 'c' + Date.now();
  const chap = document.createElement('div');
  chap.className = 'chapter';
  chap.innerHTML = `
    <div class="chapter-title">
      <span class="title-txt">${name}</span>
      <button class="del-btn">Ã—</button>
    </div>
    <div class="chapter-anchors" id="${id}"></div>`;
  
  document.getElementById('chapters').appendChild(chap);
  const opt = document.createElement('option');
  opt.value = id; opt.innerText = name;
  chapterSelect.appendChild(opt);

  chap.querySelector('.del-btn').onclick = () => {
    if (confirm("ã“ã®ç« ã¨ã€å«ã¾ã‚Œã‚‹ã‚¢ãƒ³ã‚«ãƒ¼ã‚’ã™ã¹ã¦å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
      chap.querySelectorAll('.anchor').forEach(anc => deleteAnchorLogic(anc.dataset.bid));
      chap.remove();
      opt.remove();
    }
  };
  return id;
}

function addChapterMobile() {
  const name = prompt("ç« ã®åå‰:", "æ–°ã—ã„ç« ");
  if (name) createChapter(name);
}

// ã‚¢ãƒ³ã‚«ãƒ¼è¡¨ç¤ºï¼ˆPCç‰ˆã®ãƒ­ã‚¸ãƒƒã‚¯ï¼‰
function createAnchorElement(bid, text, targetId) {
  const container = document.getElementById(targetId);
  if (!container) return;
  const anc = document.createElement('div');
  anc.className = 'anchor';
  anc.dataset.bid = bid;
  anc.innerHTML = `<span class="anchor-txt">${text.slice(0,15)}...</span><button class="del-btn">Ã—</button>`;
  container.appendChild(anc);

  anc.onclick = (e) => {
    if (e.target.classList.contains('del-btn')) {
      deleteAnchorLogic(bid);
      anc.remove();
    } else {
      switchTab('right-container', document.querySelector('.nav-item'));
      setTimeout(() => {
        const target = right.querySelector(`span[data-block-id="${bid}"]`);
        if (target) target.scrollIntoView({ behavior: "smooth", block: "center" });
      }, 200);
    }
  };
}

function deleteAnchorLogic(bid) {
  const targetSpan = right.querySelector(`span[data-block-id="${bid}"]`);
  if (targetSpan) {
    const parent = targetSpan.parentNode;
    while (targetSpan.firstChild) parent.insertBefore(targetSpan.firstChild, targetSpan);
    parent.removeChild(targetSpan);
  }
}

// ä¿å­˜
function saveData() {
  const fileName = prompt("ä¿å­˜å:", "scenario");
  if (!fileName) return;
  const htmlContent = "<!DOCTYPE html>\n" + document.documentElement.outerHTML;
  const blob = new Blob([new Uint8Array([0xEF, 0xBB, 0xBF]), htmlContent], { type: 'text/html' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob); a.download = fileName + '.html'; a.click();
}

// ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿
document.getElementById('fileInput').onchange = e => {
  const file = e.target.files[0];
  const reader = new FileReader();
  reader.readAsText(file);
  reader.onload = ev => {
    const parser = new DOMParser();
    const doc = parser.parseFromString(ev.target.result, 'text/html');
    const savedRight = doc.getElementById('right');
    const savedChapters = doc.getElementById('chapters');
    
    if (savedRight && savedChapters) {
      right.innerHTML = savedRight.innerHTML;
      document.getElementById('chapters').innerHTML = "";
      chapterSelect.innerHTML = "";
      const tempDiv = document.createElement('div');
      tempDiv.innerHTML = savedChapters.innerHTML;
      tempDiv.querySelectorAll('.chapter').forEach(oldChap => {
        const name = oldChap.querySelector('.title-txt').innerText;
        const oldId = oldChap.querySelector('.chapter-anchors').id;
        const newId = createChapter(name, oldId);
        oldChap.querySelectorAll('.anchor').forEach(oldAnc => {
          createAnchorElement(oldAnc.dataset.bid, oldAnc.querySelector('.anchor-txt').innerText, newId);
        });
      });
    } else {
        // ãŸã ã®ãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®å ´åˆ
        right.innerText = ev.target.result;
        if (chapterSelect.options.length === 0) createChapter('ç« 1');
    }
  };
};

window.onload = () => { if (!chapterSelect.options.length) createChapter('ç« 1'); };
</script>
</body>
</html>
